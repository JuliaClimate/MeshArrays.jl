<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Design · MeshArrays</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">MeshArrays</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Design</a><ul class="internal"><li><a class="tocitem" href="#Main-Features-1"><span>Main Features</span></a></li></ul></li><li><a class="tocitem" href="../API/">API</a></li><li><a class="tocitem" href="../detail/">Detail</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Design</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Design</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaClimate/MeshArrays.jl/blob/master/docs/src/main.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h2 id="Main-Features-1"><a class="docs-heading-anchor" href="#Main-Features-1">Main Features</a><a class="docs-heading-anchor-permalink" href="#Main-Features-1" title="Permalink"></a></h2><h3 id="Rationale-/-Design-1"><a class="docs-heading-anchor" href="#Rationale-/-Design-1">Rationale / Design</a><a class="docs-heading-anchor-permalink" href="#Rationale-/-Design-1" title="Permalink"></a></h3><p>The <code>MeshArray</code> type is a sub-type of <code>AbstractArray</code> with an <code>outer array</code> where each element is itself a 2D <code>inner array</code>. This setup potentially allows different choices for the outer and inner arrays – for example <code>DistributedArrays</code> and <code>AxisArrays</code>, respectively, could be an option. <code>MeshArrays.jl</code> thus provides a simple but general solution to analyze or e.g. simulate climate system variables. </p><p>The internals of a <code>MeshArray</code> are regulated by its <code>gcmgrid</code> – a struct containing just a few index ranges, array size specifications, and inter-connection rules. A second  lightweight struct, <code>varmeta</code>, contains the <code>MeshArray</code> variable name, its unit, and position in grid space. A general approach like this is useful because climate models often involve advanced domain decompositions (see <em>Earth Model Grids</em>), and many variables, which puts a burden on users. </p><p>Encoding the grid specification inside the <code>MeshArray</code> data type allows user to manipulate <code>MeshArray</code>s just like they would manipulate <code>Array</code>s without having to keep track of model grid details. In addition, the provided <code>exchange</code> methods readily transfer data between connected subdomains to extend them at the sides. This makes it easy to compute e.g. partial derivatives and related operators like gradients, curl, or divergences over subdomain edges as often needed for precise computation of transports, budgets, etc using climate model output.</p><h3 id="Data-Structures-1"><a class="docs-heading-anchor" href="#Data-Structures-1">Data Structures</a><a class="docs-heading-anchor-permalink" href="#Data-Structures-1" title="Permalink"></a></h3><p>The elements of a <code>MeshArray</code> are arrays. These elementary arrays typically represent subdomains inter-connected at their edges. The organization and connections between subdomains is determined by a user-specified <code>gcmgrid</code> which is embeded inside each <code>MeshArray</code> instance. </p><p><code>Interpolate</code> can be used to interpolate a <code>MeshArray</code> to any location (i.e. arbitrary longitude, latitude pair). <code>Exchange</code> methods transfer data between neighboring arrays to extend computational subdomains – this is often needed in analyses of climate or ocean model output. </p><p>The current default for <code>MeshArray</code> is the <code>gcmarray</code> type and an instance <code>H</code> is shown below. This example is based on a grid known as <code>LatLonCap</code> where each global map is associated with 5 subdomains. Hence, <code>H.f</code> is a <code>(5, 50)</code> array when <code>H</code> represents a gridded variable on <code>50</code> depth levels, and elements of  <code>H.f</code> are arrays of size <code>(90, 270)</code>, <code>(90, 90)</code>, or <code>(270, 90)</code>. </p><pre><code class="language-none">julia&gt; show(D)
  name        = Depth
  unit        = m
  data type   = Float64
  cell pos.   = [0.5, 0.5]

  tile array  = (5,)
  tile sizes  = (90, 270)
                (90, 270)
                (90, 90)
                (270, 90)
                (270, 90)

  grid class  = LatLonCap
  MeshArray   = gcmarray 
  version     = 0.2.7 </code></pre><p>The underlying, <code>MeshArray</code>, data structure is:</p><pre><code class="language-none">struct gcmarray{T, N} &lt;: AbstractMeshArray{T, N}
   grid::gcmgrid
   meta::varmeta
   f::Array{Array{T,2},N}
   fSize::Array{NTuple{2, Int}}
   fIndex::Array{Int,1}
   version::String
end</code></pre><p>A <code>MeshArray</code> generally behaves just like an <code>Array</code> including for operations listed below. The <em>broadcasting</em> function has been customized so that it reaches elements of each elementary array.</p><pre><code class="language-none">size(D)
eltype(D)
view(D,:)

D .* 1.0
D .* D
1000*D
D*1000

D[findall(D .&gt; 300.)] .= NaN
D[findall(D .&lt; 1.)] .= NaN

D[1]=0.0 .+ D[1]
tmp=cos.(D)</code></pre><p>In addition, <code>Mesharray</code> specific functions like <code>exchange</code> can alter the internal structure of a <code>MeshArray</code>. Elementary array sizes are thus larger in <code>show(exchange(D))</code> than <code>show(D)</code>.</p><pre><code class="language-none">julia&gt; show(exchange(D))
  tile sizes  = (92, 272)
                (92, 272)
                (92, 92)
                (272, 92)
                (272, 92)</code></pre><h3 id="Embedded-Metadata-1"><a class="docs-heading-anchor" href="#Embedded-Metadata-1">Embedded Metadata</a><a class="docs-heading-anchor-permalink" href="#Embedded-Metadata-1" title="Permalink"></a></h3><p>A <code>MeshArray</code> includes a <code>gcmgrid</code> specification which can be constructed as outlined below.</p><pre><code class="language-none">gcmgrid(path::String, class::String, 
        nFaces::Int, fSize::Array{NTuple{2, Int},1}, 
        ioSize::Array{Int64,2}, ioPrec::Type, 
        read::Function, write::Function)</code></pre><p>Importantly, a <code>gcmgrid</code> does <strong>not</strong> contain any actual grid data – hence its memory footprint is minimal. Grid variables are instead read to memory only when needed e.g. as shown below. To make this easy, each <code>gcmgrid</code> includes a pair of <code>read</code> / <code>write</code> methods to allow for basic <code>I/O</code> at any time. These methods are typically specified by the user although defaults are provided. </p><pre><code class="language-none">using MeshArrays, Unitful
γ=GridSpec(&quot;LatLonCap&quot;,&quot;GRID_LLC90/&quot;)
m=MeshArrays.varmeta(u&quot;m&quot;,fill(0.5,2),&quot;Depth&quot;,&quot;Depth&quot;)
D=γ.read(γ.path*&quot;Depth.data&quot;,MeshArray(γ,Float64;meta=m))</code></pre><p>The above commands define a <code>MeshArray</code> called <code>D</code> which is the one displayed at the top of this section. A definition of the <code>varmeta</code> structure is reported below. The <code>position</code> of a <code>D</code> point within its grid cell is given as <code>x ∈ [0. 1.]</code> in each direction.</p><pre><code class="language-none">varmeta(unit::Union{Unitful.AbstractQuantity,Number},
        position::Array{Float64,1},
        name::String,long_name::String)</code></pre><h3 id="Plotting,-Interpolation,-etc-1"><a class="docs-heading-anchor" href="#Plotting,-Interpolation,-etc-1">Plotting, Interpolation, etc</a><a class="docs-heading-anchor-permalink" href="#Plotting,-Interpolation,-etc-1" title="Permalink"></a></h3><p>The <a href="https://youtu.be/RDxAy_zSUvg">JuliaCon-2018 presentation</a> relied on two <code>Jupyter</code> notebooks available in <a href="https://github.com/juliaclimate/GlobalOceanNotebooks.git">GlobalOceanNotebooks</a>/DataStructures which are also included here in <code>examples/Demos.jl</code>. <a href="https://github.com/juliaclimate/GlobalOceanNotebooks.git">GlobalOceanNotebooks</a>/OceanTransports provides use case examples related to Earth System transports.</p><p>A simple way to plot a <code>MeshArray</code> consists in plotting each elementary array separately. Other methods that e.g. produce global maps and projections are illustrated in the notebooks. A simple one is shown below that demonstrates the included interpolation scheme.</p><pre><code class="language-none">p=dirname(pathof(MeshArrays));
using Plots; include(joinpath(p,&quot;../examples/Plots.jl&quot;));
heatmap(D,title=&quot;Ocean Depth&quot;,clims=(0.,6000.))</code></pre><p><img src="https://raw.githubusercontent.com/juliaclimate/MeshArrays.jl/master/docs/images/ocean_depth.png" alt="OceanDepthMap"/></p><pre><code class="language-none">lon=[i for i=-179.5:1.0:179.5, j=-89.5:1.0:89.5]
lat=[j for i=-179.5:1.0:179.5, j=-89.5:1.0:89.5]

Γ=GridLoad(GridSpec(&quot;LatLonCap&quot;,&quot;GRID_LLC90/&quot;))
(f,i,j,w)=InterpolationFactors(Γ,vec(lon),vec(lat))
DD=Interpolate(Γ[&quot;Depth&quot;],f,i,j,w)

contourf(vec(lon[:,1]),vec(lat[1,:]),DD,clims=(0.,6000.))</code></pre><p><img src="https://raw.githubusercontent.com/juliaclimate/MeshArrays.jl/master/docs/images/interp_depth.png" alt="OceanDepthMap"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../API/">API »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 17 June 2020 15:22">Wednesday 17 June 2020</span>. Using Julia version 1.3.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
